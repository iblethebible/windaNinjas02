{% extends "base.html" %}

{% block title %}Dashboard - Customer Management System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
        <p class="text-muted">Job management system</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="stat-card">
            <div class="stat-label">Due Jobs</div>
            <div class="stat-number">{{ due_jobs_count }}</div>
            <div class="mt-2">
                <i class="bi bi-calendar-x text-primary"></i>
                <span class="text-muted ms-2">Require attention</span>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-label">Unpaid Earnings</div>
            <div class="stat-number">£{{ "%.2f"|format(unpaid_earnings) }}</div>
            <div class="mt-2">
                <i class="bi bi-exclamation-triangle text-primary"></i>
                <span class="text-muted ms-2">Outstanding</span>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stat-card">
            <div class="stat-label">Quick Actions</div>
            <div class="mt-3">
                <a href="{{ url_for('add_customer') }}" class="btn btn-primary w-100 mb-2">
                    <i class="bi bi-person-plus me-2"></i>Add New Customer
                </a>
                <a href="{{ url_for('add_job') }}" class="btn btn-outline-primary w-100">
                    <i class="bi bi-briefcase me-2"></i>Add New Job
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Jobs by Due Date</h5>
                    </div>
                    <div class="col-md-6">
                        <select id="zoneFilter" class="form-select">
                            <option value="all">All Jobs</option>
                            {% for zone in zones %}
                            <option value="{{ zone.idzone }}">{{ zone.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if jobs_by_due %}
                <div class="table-responsive">
                    <table class="table table-hover" id="dueJobsTable">
                        <thead>
                            <tr>
                                <th>Job</th>
                                <th>Customer</th>
                                <th>Zone</th>
                                <th>Price</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in jobs_by_due %}
                            {% set job = item.job %}
                            {% set days_overdue = item.days_overdue %}
                            <tr style="cursor: pointer;" data-href="{{ url_for('job_detail', id=job.idjob) }}" 
                                data-zone="{% if job.zone_id %}{{ job.zone_id }}{% endif %}">
                                <td>
                                    {% if job.address %}
                                        {% if job.address.house_num_name and job.address.street_name %}
                                            {{ job.address.house_num_name }} {{ job.address.street_name }}
                                        {% elif job.address.postcode %}
                                            {{ job.address.postcode }}
                                        {% else %}
                                            Job #{{ job.idjob }}
                                        {% endif %}
                                    {% else %}
                                        Job #{{ job.idjob }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if job.customer %}
                                        <a href="{{ url_for('customer_detail', id=job.customer_id) }}" onclick="event.stopPropagation();">
                                            {{ job.customer.forename or '' }} {{ job.customer.surname or '' }}
                                        </a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if job.zone_id %}
                                        {% set zone_obj = zones|selectattr('idzone', 'equalto', job.zone_id)|first %}
                                        {% if zone_obj %}
                                            {{ zone_obj.name }}
                                        {% else %}
                                            Zone ID: {{ job.zone_id }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if job.price %}
                                        <span class="text-success fw-bold">£{{ "%.2f"|format(job.price) }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if job.date_next_due %}
                                        {{ job.date_next_due.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        <span class="text-muted">Not set</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if days_overdue == "No due date set" %}
                                        <span class="badge bg-warning">Due</span>
                                    {% elif days_overdue > 0 %}
                                        <span class="badge bg-danger">Overdue ({{ days_overdue }}d)</span>
                                    {% elif days_overdue == 0 %}
                                        <span class="badge bg-warning">Due Today</span>
                                    {% else %}
                                        <span class="badge bg-info">Due in {{ -days_overdue }}d</span>
                                    {% endif %}
                                </td>
                                <td onclick="event.stopPropagation();">
                                    <a href="{{ url_for('job_detail', id=job.idjob) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle" style="font-size: 3rem; color: #10b981;"></i>
                    <p class="text-muted mt-3">No jobs found.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Zone filter functionality
    document.getElementById('zoneFilter').addEventListener('change', function() {
        const selectedZone = this.value;
        const rows = document.querySelectorAll('#dueJobsTable tbody tr');
        
        rows.forEach(row => {
            const rowZone = row.dataset.zone || '';
            if (selectedZone === 'all' || rowZone === selectedZone) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Make rows clickable
    document.querySelectorAll('#dueJobsTable tbody tr[data-href]').forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't navigate if clicking on action buttons
            if (!e.target.closest('td:last-child')) {
                window.location.href = this.dataset.href;
            }
        });
    });
</script>
{% endblock %}

